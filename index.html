<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hayton Gobblet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    /* Global background: show the entire image with black margins */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Roboto', sans-serif;
      background-color: black;
      background-image: url("assets/images/Gobblet-backround.png");
      background-repeat: no-repeat;
      background-position: center center;
      background-size: contain;
    }

    h1 {
      text-align: center;
      margin: 1em 0 0.5em 0;
      color: #fff;
    }

    /* Main layout: left supply, board in center, right supply */
    .game-layout {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 20px;
    }

    /* Supply container styling */
    .supply-container {
      width: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .supply-container h2 {
      margin-bottom: 10px;
      font-size: 1.1em;
      color: #fff;
    }
    .supply {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    .supply .piece {
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .supply .piece:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    /* Board container: no extra overlay */
    .board-container {
      flex: 1;
      margin-top: 20px;
      position: relative;
    }
    .board-container h2 {
      margin-bottom: 10px;
      font-size: 1.2em;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
      text-align: center;
    }

    /* 4x4 board grid */
    .board {
      display: grid;
      grid-template-columns: repeat(4, 90px);
      grid-gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .square {
      width: 90px;
      height: 90px;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .square:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Pieces styling */
    .piece {
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      position: relative;
    }
    .size1 { width: 35px; height: 35px; font-size: 0.75em; }
    .size2 { width: 45px; height: 45px; font-size: 0.85em; }
    .size3 { width: 55px; height: 55px; font-size: 1em; }
    .size4 { width: 65px; height: 65px; font-size: 1.1em; }

    /* Player colors: red for Player 1, blue for Player 2 */
    .player1 { background: #e74c3c; }
    .player2 { background: #3498db; }

    /* Fixed controls: Reset and Music Buttons */
    .controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
    }
    .controls button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 0.7em 1.2em;
      font-size: 1em;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s ease;
      margin: 5px;
    }
    .controls button:hover {
      background: #2980b9;
    }
  </style>
</head>
<body>
  <h1>Hayton Gobblet</h1>

  <div class="game-layout">
    <!-- Left Supply (Player 1) -->
    <div class="supply-container">
      <h2>Player 1</h2>
      <div id="player1-supply" class="supply"></div>
    </div>

    <!-- Board in Center -->
    <div class="board-container">
      <h2>The Board</h2>
      <div id="board" class="board"></div>
    </div>

    <!-- Right Supply (Player 2) -->
    <div class="supply-container">
      <h2>Player 2</h2>
      <div id="player2-supply" class="supply"></div>
    </div>
  </div>

  <!-- Fixed Controls -->
  <div class="controls">
    <button id="reset-btn">Reset Game</button>
    <button id="play-music-btn">Play Music</button>
    <button id="pause-music-btn">Pause Music</button>
  </div>

  <!-- Background Music -->
  <audio id="bg-music" src="assets/music/ambient.mp3" autoplay loop></audio>

  <script>
    /***************************************************************
     * Gobblet Game Logic (without move timer)
     ***************************************************************/
    let board = [];
    const ROWS = 4;
    const COLS = 4;
    const player1Pieces = [];
    const player2Pieces = [];
    let currentPlayer = 1;  // Assume Player 1 is human, Player 2 is bot
    let selectedPiece = null;

    const boardEl = document.getElementById('board');
    const player1SupplyEl = document.getElementById('player1-supply');
    const player2SupplyEl = document.getElementById('player2-supply');
    const resetBtn = document.getElementById('reset-btn');

    // Music controls
    const bgMusic = document.getElementById('bg-music');
    const playMusicBtn = document.getElementById('play-music-btn');
    const pauseMusicBtn = document.getElementById('pause-music-btn');

    let botWorker = new Worker("botWorker.js");

    /***************************************************************
     * Game Initialization & Rendering
     ***************************************************************/
    function initBoard() {
      board = [];
      for (let r = 0; r < ROWS; r++) {
        board[r] = [];
        for (let c = 0; c < COLS; c++) {
          board[r][c] = [];
        }
      }
    }

    function initSupplies() {
      player1Pieces.length = 0;
      player2Pieces.length = 0;
      let idCounter1 = 1;
      let idCounter2 = 1;

      function addPiecesForPlayer(player, size) {
        for (let i = 0; i < 3; i++) {
          let piece = {
            id: player === 1 ? `P1-${idCounter1++}` : `P2-${idCounter2++}`,
            player,
            size,
            used: false
          };
          if (player === 1) player1Pieces.push(piece);
          else player2Pieces.push(piece);
        }
      }

      [1, 2, 3, 4].forEach(sz => {
        addPiecesForPlayer(1, sz);
        addPiecesForPlayer(2, sz);
      });
    }

    function renderBoard() {
      boardEl.innerHTML = '';
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const squareDiv = document.createElement('div');
          squareDiv.classList.add('square');
          squareDiv.id = `square-${r}-${c}`;
          squareDiv.onclick = () => handleSquareClick(r, c);

          let stack = board[r][c];
          if (stack.length > 0) {
            const topPiece = stack[stack.length - 1];
            const pieceDiv = createPieceDiv(topPiece);
            pieceDiv.style.position = 'absolute';
            pieceDiv.style.top = '50%';
            pieceDiv.style.left = '50%';
            pieceDiv.style.transform = 'translate(-50%, -50%)';
            squareDiv.appendChild(pieceDiv);
          }
          boardEl.appendChild(squareDiv);
        }
      }
    }

    function renderSupplies() {
      player1SupplyEl.innerHTML = '';
      player2SupplyEl.innerHTML = '';

      player1Pieces.forEach(piece => {
        if (!piece.used) {
          const div = createPieceDiv(piece);
          div.onclick = () => pickUpFromSupply(piece);
          player1SupplyEl.appendChild(div);
        }
      });
      player2Pieces.forEach(piece => {
        if (!piece.used) {
          const div = createPieceDiv(piece);
          div.onclick = () => pickUpFromSupply(piece);
          player2SupplyEl.appendChild(div);
        }
      });
    }

    function createPieceDiv(piece) {
      const div = document.createElement('div');
      div.classList.add('piece', `player${piece.player}`, `size${piece.size}`);
      return div;
    }

    /***************************************************************
     * Player Interaction
     ***************************************************************/
    function pickUpFromSupply(piece) {
      if (piece.player !== currentPlayer) {
        alert(`It's Player ${currentPlayer}'s turn, not yours!`);
        return;
      }
      if (selectedPiece) {
        alert('You already have a piece in hand. Place it first or reselect.');
        return;
      }
      selectedPiece = {
        id: piece.id,
        player: piece.player,
        size: piece.size,
        from: 'supply'
      };
    }

    function handleSquareClick(r, c) {
      let stack = board[r][c];

      // If no piece is selected, try to pick up the top piece from the board
      if (!selectedPiece) {
        if (stack.length === 0) {
          alert('No piece here to pick up.');
          return;
        }
        const topPiece = stack[stack.length - 1];
        if (topPiece.player !== currentPlayer) {
          alert(`Top piece belongs to Player ${topPiece.player}, not you!`);
          return;
        }
        stack.pop();
        selectedPiece = {
          id: topPiece.id || null,
          player: topPiece.player,
          size: topPiece.size,
          from: 'board',
          row: r,
          col: c
        };
        renderBoard();
        return;
      }

      // If a piece is selected, attempt to place it
      if (stack.length > 0) {
        const topPiece = stack[stack.length - 1];
        if (selectedPiece.size <= topPiece.size) {
          alert(`Your piece is too small to cover size ${topPiece.size}.`);
          return;
        }
      }
      stack.push({
        player: selectedPiece.player,
        size: selectedPiece.size,
        id: selectedPiece.id
      });
      if (selectedPiece.from === 'supply') markPieceUsed(selectedPiece);
      renderBoard();
      renderSupplies();
      if (checkWin(selectedPiece.player)) {
        alert(`Player ${selectedPiece.player} wins!`);
        disableAllMoves();
        return;
      }
      // Switch turn: if it's now the bot's turn, trigger the bot move.
      selectedPiece = null;
      currentPlayer = currentPlayer === 1 ? 2 : 1;
      if (currentPlayer === 2) {
        startBotTurn();
      }
    }

    function markPieceUsed(sel) {
      if (sel.player === 1) {
        const p = player1Pieces.find(p => p.id === sel.id);
        if (p) p.used = true;
      } else {
        const p = player2Pieces.find(p => p.id === sel.id);
        if (p) p.used = true;
      }
    }

    function disableAllMoves() {
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const squareDiv = document.getElementById(`square-${r}-${c}`);
          if (squareDiv) squareDiv.onclick = null;
        }
      }
      player1SupplyEl.querySelectorAll('.piece').forEach(el => el.onclick = null);
      player2SupplyEl.querySelectorAll('.piece').forEach(el => el.onclick = null);
    }

    function checkWin(player) {
      let topGrid = [];
      for (let r = 0; r < ROWS; r++) {
        topGrid[r] = [];
        for (let c = 0; c < COLS; c++) {
          let stack = board[r][c];
          topGrid[r][c] = stack.length > 0 ? stack[stack.length - 1].player : 0;
        }
      }
      // Check rows, columns, and diagonals
      for (let r = 0; r < ROWS; r++) {
        if (topGrid[r].every(p => p === player)) return true;
      }
      for (let c = 0; c < COLS; c++) {
        const colVals = [];
        for (let r = 0; r < ROWS; r++) {
          colVals.push(topGrid[r][c]);
        }
        if (colVals.every(p => p === player)) return true;
      }
      let diag1 = [topGrid[0][0], topGrid[1][1], topGrid[2][2], topGrid[3][3]];
      if (diag1.every(p => p === player)) return true;
      let diag2 = [topGrid[0][3], topGrid[1][2], topGrid[2][1], topGrid[3][0]];
      if (diag2.every(p => p === player)) return true;
      return false;
    }

    /***************************************************************
     * Bot Turn Using Web Worker
     ***************************************************************/
    function startBotTurn() {
      // Bot Web Worker setup (assumes botWorker.js is configured for Pyodide)
      const state = {
        board: board,
        supply1: player1Pieces,
        supply2: player2Pieces,
        currentPlayer: currentPlayer
      };
      // Send the current state and a 30-second time limit (in ms) to the bot worker.
      botWorker.postMessage({ state: state, timeLimit: 30000 });
    }

    // Listen for messages from the bot worker.
    botWorker.onmessage = function(e) {
      const { move, error } = e.data;
      if (error) {
        alert("Bot error: " + error);
        return;
      }
      if (move) {
        // Apply the bot move.
        applyBotMove(move);
      }
    };

    function applyBotMove(move) {
      // If the move is from supply, mark the piece as used.
      if (move.type === "supply") {
        const supply = move.piece.player === 1 ? player1Pieces : player2Pieces;
        const p = supply.find(p => p.id === move.piece.id);
        if (p) p.used = true;
      } else if (move.type === "board") {
        // Remove piece from its original cell.
        let stack = board[move.from.row][move.from.col];
        if (stack.length > 0) stack.pop();
      }
      // Place piece on destination cell.
      board[move.to.row][move.to.col].push({
        player: move.piece.player,
        size: move.piece.size,
        id: move.piece.id
      });
      renderBoard();
      renderSupplies();
      if (checkWin(move.piece.player)) {
        alert(`Player ${move.piece.player} wins!`);
        disableAllMoves();
        return;
      }
      // Switch turn back to human.
      currentPlayer = 1;
    }

    /***************************************************************
     * Game Initialization
     ***************************************************************/
    function initGame() {
      initBoard();
      initSupplies();
      renderBoard();
      renderSupplies();
      currentPlayer = 1;
      selectedPiece = null;
    }

    resetBtn.addEventListener('click', initGame);

    // Music controls
    playMusicBtn.addEventListener('click', () => bgMusic.play());
    pauseMusicBtn.addEventListener('click', () => bgMusic.pause());

    window.onload = initGame;
  </script>
</body>
</html>
